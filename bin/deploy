#!/usr/bin/env bash

abspath="$(cd "${0%/*}" 2>/dev/null; echo "$PWD"/"${0##*/}")"
bin_dir=`dirname $abspath`
root_dir=`dirname $bin_dir`
app_name=`basename $root_dir`

server=${1:-ec2-54-149-118-248.us-west-2.compute.amazonaws.com}

if [[ ! -n $(git status --porcelain) ]]; then
  echo "Deploying to $server"
  git push $server:git/$app_name.git master
  ssh $server "kill \`ps ux | grep ruby | grep -v grep | awk \"{ print \$2 }\"\`"
  ssh $server "git/$app_name.git/bin/start.sh"
else
  git status
fi
